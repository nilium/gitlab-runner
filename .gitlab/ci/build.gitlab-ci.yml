.binaries: &binaries
  extends:
  - .merge_request_pipelines
  - .except_docs
  stage: build
  needs:
  # prepare done is used as a sentinel for "Prebuild" stage completion, so we can kick off builds without
  # waiting for the Test stage
  - prepare done
  script:
  - source ci/touch_make_dependencies
  - export platforms=$(echo $CI_JOB_NAME | sed 's|binaries ||')
  - make build_all BUILD_PLATFORMS="-osarch='$platforms'"
  artifacts:
    paths:
    - out/binaries/
    expire_in: 7d

binaries darwin/amd64: *binaries
binaries freebsd/386 freebsd/amd64 freebsd/arm: *binaries
binaries linux/386 linux/amd64 linux/arm linux/arm64: *binaries
binaries windows/386 windows/amd64: *binaries
